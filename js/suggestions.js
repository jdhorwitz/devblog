export class Suggestion{constructor(e,t){this.data=e,this.parent=t,this.element=document.createElement("li"),this.render(this.element),this.element.addEventListener("mouseenter",(e=>{e.stopPropagation(),e.preventDefault(),this.element.dispatchEvent(new CustomEvent("suggestion:hover",{detail:this,bubbles:!0}))})),this.element.addEventListener("click",(e=>{e.stopPropagation(),e.preventDefault(),this.element.dispatchEvent(new CustomEvent("suggestion:click",{detail:this,bubbles:!0}))}))}get focused(){return this.element.classList.contains("is-focused")}render(e){e.innerHTML=this.data.label}refresh(e,t){this.blur(),t(this)?(this.parent.element.appendChild(this.element),e.push(this)):this.element.remove()}focus(){this.element.classList.add("is-focused"),this.element.dispatchEvent(new CustomEvent("suggestion:focus",{detail:this,bubbles:!0}))}blur(){this.element.classList.remove("is-focused"),this.element.dispatchEvent(new CustomEvent("suggestion:blur",{detail:this,bubbles:!0}))}scroll(){let e;if(this.parent.wrapper){let t,s;const i=this.parent.parent.element.getBoundingClientRect();this.element.previousElementSibling?s=t=this.element.getBoundingClientRect():(t=this.parent.wrapper.getBoundingClientRect(),s=this.element.getBoundingClientRect()),i.top-t.top>0?e=this.element.previousElementSibling?"start":"center":i.bottom<s.bottom&&(e=this.element.nextElementSibling?"end":"center")}else{const t=this.parent.element.getBoundingClientRect(),s=this.element.getBoundingClientRect();t.top-s.top>0?e=this.element.previousElementSibling?"start":"center":t.bottom<s.bottom&&(e=this.element.previousElementSibling?"end":"center")}if(e)try{this.element.scrollIntoView({behavior:"smooth",block:e})}catch(e){this.element.scrollIntoView()}}}export class Group{constructor(e,t){this.data=e,this.parent=t,this.suggestions=[],this.cache={},this.wrapper=document.createElement("li"),this.element=document.createElement("ul"),this.render(this.wrapper),this.wrapper.appendChild(this.element),e.options&&this.load(e.options)}load(e){this.element.innerHTML="",this.suggestions=e.map((e=>this.loadSuggestion(e)))}loadSuggestion(e){return this.cache[e.value]||(this.cache[e.value]=this.createSuggestion(e,this.element)),this.cache[e.value]}createSuggestion(e){return new Suggestion(e,this)}render(e){e.innerHTML=`<strong>${this.data.label}</strong>`}refresh(e,t){this.suggestions.forEach((s=>s.refresh(e,t))),this.element.childElementCount?this.parent.element.appendChild(this.wrapper):this.wrapper.remove()}}export class Suggestions{static createFromElement(e,t){return new Suggestions(t||e.parentElement).load(function(e){const t=[];return e.querySelectorAll("optgroup").forEach((e=>{const s=[];e.querySelectorAll("option").forEach((e=>s.push(Object.assign({label:e.label,value:e.value},e.dataset)))),t.push({label:e.label,options:s})})),e.querySelectorAll("option").forEach((e=>{"OPTGROUP"!==e.parentElement.tagName&&t.push(Object.assign({label:e.label,value:e.value},e.dataset))})),t}(e))}constructor(e=document.body){this.closed=!0,this.cache={groups:{},suggestions:{}},this.data=[],this.suggestions=[],this.focusedIndex=0,this.element=this.render(),e.appendChild(this.element),this.element.addEventListener("suggestion:hover",(e=>{this.focus(this.suggestions.findIndex((t=>t===e.detail)))})),this.element.addEventListener("suggestion:click",(e=>{this.focus(this.suggestions.findIndex((t=>t===e.detail)))}))}get focused(){const e=this.suggestions[this.focusedIndex];if(e&&e.focused)return e}attachInput(e){let t;this.input=e,this.input.setAttribute("autocomplete","off"),this.input.removeAttribute("list"),this.input.addEventListener("input",(e=>{const t=this.input.value;t?this.filter(t):this.close()})),this.input.addEventListener("focus",(e=>{t=this.input.value}));const s={40:"ArrowDown",38:"ArrowUp",13:"Enter",27:"Escape"};this.input.addEventListener("keydown",(e=>{switch(e.code||s[e.keyCode]){case"ArrowDown":e.preventDefault(),this.closed?this.element.value&&this.open():void 0===this.focusedIndex?this.focus(0):this.focus(this.focusedIndex+1);break;case"ArrowUp":e.preventDefault(),this.closed||this.focus(this.focusedIndex-1);break;case"Enter":this.closed||(this.select(this.focused),e.preventDefault());break;case"Escape":this.close(),this.element.value=t}})),this.element.addEventListener("suggestion:click",(e=>this.select(e.detail)))}render(){return document.createElement("ul")}createSuggestion(e){return new Suggestion(e,this)}createGroup(e){return new Group(e,this)}load(e){return this.element.innerHTML="",this.data=e.map((e=>{if("options"in e){const t=this.cache.groups;return t[e.label]?t[e.label].load(e.options):t[e.label]=this.createGroup(e,this.element),t[e.label]}const t=this.cache.suggestions;return t[e.value]||(t[e.value]=this.createSuggestion(e,this.element)),t[e.value]})),this.query&&this.filter(this.query,!1),this}refresh(e){return this.suggestions=[],this.data.forEach((t=>t.refresh(this.suggestions,e))),this.element.childElementCount?(this.open(),this.input.dispatchEvent(new CustomEvent("suggestions:refresh")),this):this.close()}focus(e){return this.suggestions[e]&&(this.suggestions[this.focusedIndex]&&this.suggestions[this.focusedIndex].blur(),this.suggestions[e].focus(),this.focusedIndex=e,this.closed||this.suggestions[e].scroll()),this}select(e){return this.input.value=e.data.value,this.input.dispatchEvent(new CustomEvent("suggestions:select",{detail:e})),this.close()}close(){return this.closed=!0,this.element.classList.remove("is-open"),this.input.dispatchEvent(new CustomEvent("suggestions:close")),this}open(){return this.closed=!1,this.element.classList.add("is-open"),this.input.dispatchEvent(new CustomEvent("suggestions:open")),this.focused?this.focused.focus():this.input.value&&this.focus(0),this}filter(t,s=!0){return(t=s?e(t):t).length?(this.query=t,t=t.split(" "),this.refresh((s=>(s.search||(s.search=e(s.data.search||`${s.data.label} ${s.data.value}`)),t.every((e=>-1!==s.search.indexOf(e)))))),this):this.close()}destroy(){return this.input.removeEventListener("input"),this.input.removeEventListener("focus"),this.input.removeEventListener("keydown"),this.element.remove(),this}}export class AjaxSuggestions extends Suggestions{constructor(e,t){super(t),this.endpoint=e,this.cache={groups:{},suggestions:{}}}filter(t,s=!1){return(t=s?e(t):t).length<2?this.close():this.query===t?this.refresh((()=>!0)):(this.query=t,this.waiting||this.loadData(t).then((()=>this.refresh((()=>!0)))).then((()=>{this.query&&this.query!==t&&(t=this.query,delete this.query,this.filter(t))})),this)}loadData(e){return this.cache[e]?(this.load(this.cache[e]),Promise.resolve()):(this.waiting=!0,(t=this.endpoint+"?q="+e,new Promise(((e,s)=>{const i=new XMLHttpRequest;i.open("GET",t,!0),i.setRequestHeader("Accept","application/json"),i.onload=()=>{i.status>=200&&i.status<400?e(JSON.parse(i.responseText)):s(`The request status code is ${i.status}`)},i.send()}))).catch((e=>console.error(e))).then((t=>(this.cache[e]=t,this.load(t),new Promise((e=>setTimeout((()=>{this.waiting=!1,e()}),200)))))));var t}}function e(e){const t={a:/á/gi,e:/é/gi,i:/í/gi,o:/ó/gi,u:/ú/gi};e=e.toLowerCase();for(let s in t)e=e.replace(t[s],s);return e.replace(/[^\wñç\s]/gi,"").replace(/\s+/g," ").trim()}